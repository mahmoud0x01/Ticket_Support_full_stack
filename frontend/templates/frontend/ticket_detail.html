{% extends 'base.html' %}

{% block title %}Ticket #{{ ticket.id }} - TicketPro{% endblock %}

{% block content %}
<div class="mb-8">
    <div class="flex items-center mb-6">
        <a href="{% url 'dashboard' %}" class="text-indigo-600 hover:text-indigo-800 mr-4">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        <h1 class="text-3xl font-bold text-indigo-700">Ticket #{{ ticket.id }}</h1>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Ticket Details -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
                <div class="border-b px-6 py-4">
                    <h2 class="text-xl font-semibold">{{ ticket.title }}</h2>
                </div>
                <div class="p-6">
                    <div class="flex flex-wrap gap-4 mb-6">
                        <div class="bg-gray-100 px-4 py-2 rounded-lg">
                            <span class="text-sm text-gray-500">Status</span>
                            <div class="font-medium
                                {% if ticket.status == 'open' %}text-yellow-600
                                {% elif ticket.status == 'in_progress' %}text-blue-600
                                {% elif ticket.status == 'resolved' %}text-green-600
                                {% elif ticket.status == 'closed' %}text-gray-600
                                {% endif %}">
                                {{ ticket.get_status_display }}
                            </div>
                        </div>

                        <div class="bg-gray-100 px-4 py-2 rounded-lg">
                            <span class="text-sm text-gray-500">Priority</span>
                            <div class="font-medium
                                {% if ticket.priority == 'low' %}text-green-600
                                {% elif ticket.priority == 'medium' %}text-blue-600
                                {% elif ticket.priority == 'high' %}text-orange-600
                                {% elif ticket.priority == 'urgent' %}text-red-600
                                {% endif %}">
                                {{ ticket.get_priority_display }}
                            </div>
                        </div>

                        <div class="bg-gray-100 px-4 py-2 rounded-lg">
                            <span class="text-sm text-gray-500">Created</span>
                            <div class="font-medium">{{ ticket.created_at|date:"M d, Y" }}</div>
                        </div>

                        <div class="bg-gray-100 px-4 py-2 rounded-lg">
                            <span class="text-sm text-gray-500">Created By</span>
                            <div class="font-medium">{{ ticket.created_by.get_full_name }}</div>
                        </div>

                        <div class="bg-gray-100 px-4 py-2 rounded-lg">
                            <span class="text-sm text-gray-500">Assigned To</span>
                            <div class="font-medium">
                                {% if ticket.assigned_to %}
                                    {{ ticket.assigned_to.get_full_name }}
                                {% else %}
                                    Not assigned
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-2">Description</h3>
                        <div class="bg-gray-50 p-4 rounded-lg whitespace-pre-wrap">{{ ticket.description }}</div>
                    </div>

                    {% if user.user_type == 'admin' or user == ticket.assigned_to %}
                    <div class="border-t pt-6">
                        <h3 class="text-lg font-medium mb-4">Ticket Management</h3>
                        <div class="flex flex-wrap gap-4">
                            <form method="POST" action="{% url 'update_ticket_status' ticket.id %}" class="flex gap-2">
                                {% csrf_token %}
                                <select name="status" class="px-3 py-2 border rounded-lg focus:outline-none focus:border-indigo-500">
                                    <option value="open" {% if ticket.status == 'open' %}selected{% endif %}>Open</option>
                                    <option value="in_progress" {% if ticket.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                                    <option value="resolved" {% if ticket.status == 'resolved' %}selected{% endif %}>Resolved</option>
                                    <option value="closed" {% if ticket.status == 'closed' %}selected{% endif %}>Closed</option>
                                </select>
                                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition duration-300">
                                    Update Status
                                </button>
                            </form>

                            {% if user.user_type == 'admin' %}
                            <form method="POST" action="{% url 'assign_ticket' ticket.id %}" class="flex gap-2">
                                {% csrf_token %}
                                <select name="assigned_to" class="px-3 py-2 border rounded-lg focus:outline-none focus:border-indigo-500">
                                    <option value="">Unassigned</option>
                                    {% for staff in support_staff %}
                                    <option value="{{ staff.id }}" {% if ticket.assigned_to == staff %}selected{% endif %}>
                                        {{ staff.get_full_name }} ({{ staff.email }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition duration-300">
                                    Assign
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if user.user_type == 'admin' %}
            <div class="mt-6 bg-white shadow rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900">Ticket Assignment</h3>

                <div class="mt-4">
                    {% if ticket.assigned_to %}
                        <p class="text-sm text-gray-600">
                            Currently assigned to: <span class="font-medium">{{ ticket.assigned_to.first_name }} {{ ticket.assigned_to.last_name }}</span>
                        </p>
                    {% else %}
                        <p class="text-sm text-gray-600">This ticket is not assigned to anyone.</p>
                    {% endif %}
                </div>

                <div class="mt-4">
                    <form action="{% url 'assign_ticket' ticket.id %}" method="POST">
                        {% csrf_token %}
                        <div class="flex items-center space-x-4">
                            <select name="support_id" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <option value="">-- Select an option --</option>
                                {% if ticket.assigned_to %}
                                    <option value="unassign">Unassign ticket</option>
                                {% endif %}
                                <optgroup label="Support Staff">
                                    {% for staff in support_staff %}
                                        <option value="{{ staff.id }}" {% if ticket.assigned_to == staff %}selected{% endif %}>
                                            {{ staff.first_name }} {{ staff.last_name }}
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            </select>
                            <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Update Assignment
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Chat Section -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md overflow-hidden h-full flex flex-col">
                <div class="border-b px-6 py-4">
                    <h2 class="text-xl font-semibold">Support Chat</h2>
                </div>

                <div id="chat-messages" class="flex-grow p-4 overflow-y-auto h-96">
                    <div class="text-center text-gray-500 text-sm mb-4">Loading chat history...</div>
                </div>

                <div class="border-t p-4">
                    <form id="chat-form" class="flex gap-2">
                        <input type="text" id="chat-message" class="flex-grow px-4 py-2 border rounded-lg focus:outline-none focus:border-indigo-500" placeholder="Type your message...">
                        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition duration-300">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // WebSocket connection for chat
    const ticketId = {{ ticket.id }};
    const userId = {{ user.id }};
    const userFirstName = "{{ user.first_name }}";
    const userLastName = "{{ user.last_name }}";
    const userType = "{{ user.user_type }}";

    let chatSocket;

    function connectWebSocket() {
        chatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/chat/' + ticketId + '/'
        );

        chatSocket.onopen = function(e) {
            console.log('WebSocket connection established');
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);

            if (data.type === 'chat_history') {
                displayChatHistory(data.messages);
            } else if (data.type === 'chat_message') {
                // Remove "No messages yet" notice if it exists
                const chatMessages = document.getElementById('chat-messages');
                const noMessagesNotice = chatMessages.querySelector('.text-center.text-gray-500.py-4');
                if (noMessagesNotice) {
                    chatMessages.innerHTML = '';
                }

                addMessage(data);
            }
        };

        chatSocket.onclose = function(e) {
            console.log('WebSocket connection closed');
            // Try to reconnect after a delay
            setTimeout(function() {
                connectWebSocket();
            }, 3000);
        };
    }

    function displayChatHistory(messages) {
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.innerHTML = '';

        if (messages.length === 0) {
            chatMessages.innerHTML = '<div class="text-center text-gray-500 py-4">No messages yet. Start the conversation!</div>';
            return;
        }

        messages.forEach(message => {
            addMessageToDOM(message);
        });

        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addMessage(message) {
        addMessageToDOM(message);

        // Scroll to bottom
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addMessageToDOM(message) {
        const chatMessages = document.getElementById('chat-messages');
        const isCurrentUser = message.user_id === userId;
        const isSystemMessage = message.user_type === 'system';

        // Remove "No messages yet" placeholder if it exists
        const noMessagesPlaceholder = document.querySelector('.no-messages-placeholder');
        if (noMessagesPlaceholder) {
            noMessagesPlaceholder.remove();
        }

        const messageDiv = document.createElement('div');

        if (isSystemMessage) {
            // Improved system message styling
            messageDiv.className = 'flex justify-center my-4';
            messageDiv.innerHTML = `
                <div class="inline-block w-3/4 bg-gradient-to-r from-gray-100 to-gray-200 border border-gray-300 rounded-lg px-4 py-2 text-center shadow-sm">
                    <div class="flex items-center justify-center mb-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-indigo-500 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="text-xs font-medium text-indigo-600">System Notification</span>
                    </div>
                    <div class="break-words text-sm text-gray-700">${message.message}</div>
                    <div class="text-xs text-gray-500 mt-1">${new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                </div>
            `;
        } else {
            // Regular user message styling (unchanged)
            messageDiv.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'} mb-4`;

            const timestamp = new Date(message.timestamp);
            const formattedTime = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            // Create badge for support staff
            const userBadge = message.user_type === 'support' ?
                `<span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                    Support
                </span>` :
                (message.user_type === 'admin' ?
                `<span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                    Admin
                </span>` : '');

            messageDiv.innerHTML = `
                <div class="inline-block max-w-3/4 ${isCurrentUser ? 'bg-indigo-100 text-left' : 'bg-gray-100'} rounded-lg px-4 py-2">
                    ${!isCurrentUser ?
                        `<div class="font-medium text-indigo-600 flex items-center">
                            ${message.first_name} ${message.last_name}
                            ${userBadge}
                        </div>` : ''}
                    <div class="break-words">${message.message}</div>
                    <div class="text-xs text-gray-500 mt-1">${formattedTime}</div>
                </div>
            `;
        }

        chatMessages.appendChild(messageDiv);

        // Scroll to the bottom of the chat
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    document.addEventListener('DOMContentLoaded', function() {
        connectWebSocket();

        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-message');

        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const message = chatInput.value.trim();
            if (message) {
                // Remove "No messages yet" notice if it exists when sending a message
                const chatMessages = document.getElementById('chat-messages');
                const noMessagesNotice = chatMessages.querySelector('.text-center.text-gray-500.py-4');
                if (noMessagesNotice) {
                    chatMessages.innerHTML = '';
                }

                chatSocket.send(JSON.stringify({
                    'message': message,
                    'user_id': userId,
                    'first_name': userFirstName,
                    'last_name': userLastName,
                    'user_type': userType
                }));

                chatInput.value = '';
            }
        });
    });
</script>
{% endblock %}

{% endblock %}